<pre> ```mermaid flowchart TD A["開始\n(スクリプト起動)"] --> B[WHILL 初期化] B --> C[パラメータ読み込み] C --> D[カメラ & YOLO モデル準備] D --> E[VideoWriter 初期化] E --> F[キー待ち: 's' で開始, 'q' で終了] F -->|s| G[メインループ開始] F -->|q| Z[終了処理] subgraph メインループ G --> H[フレーム取得] H --> I{取得失敗?} I -- Yes --> Z I -- No --> J[YOLO 推論 & ボックス取得] J --> K[スケーリング・ROI帯計算] K --> L[ROI 内検出\n(majority_side 判定)] L --> M[全検出に対し\n距離 Dg を計算] M --> N[min_Dg, target 算出] N --> O{First_Dg 未設定?} O -- Yes & valid target --> P[First_Dg = min_Dg に設定] O -- No --> Q[続行] P --> Q Q --> R[RANSAC 直線性判定\n→ inlier_ratio 算出] R --> S[方向履歴に保存\n(direction_history)] S --> T[制御ロジック:\n距離誤差 & 偏りに応じた\nforward, side 計算] T --> U[drive_velocity 呼び出し] U --> V[描画処理\n(ROI帯, boxes, UI表示)] V --> W[出力動画に書き込み\n& 画面表示] W --> X[キー判定: 'q'?] X -- Yes --> Z X -- No --> Y[時間調整\n(LOOP_INTERVAL)] Y --> G end Z[終了処理] --> ZA[drive_velocity(0,0)\nWHILL 電源OFF\nカメラ & VideoWriter 解放\nウィンドウ破棄] ``` </pre>
